# Кейс №3 - миграция

- [Кейс №3 - миграция](#кейс-3---миграция)
  - [Цель](#цель)
  - [Стэк](#стэк)
  - [Ввод новых нод](#ввод-новых-нод)
    - [Чекпоинты](#чекпоинты)
    - [Результат](#результат)
  - [Реиндексация в удаленный кластер](#реиндексация-в-удаленный-кластер)
    - [Чекпоинты](#чекпоинты-1)
    - [Результат](#результат-1)
  - [Контакты](#контакты)

## Цель

Организовать перенос данных в Opensearch при следующих сценариях:

* Ввод новых нод в эксплуатацию и вывод старых;
* Реиндексация в удаленный кластер.

## Стэк

![Opensearch](https://img.shields.io/badge/opensearch-005EB8.svg?style=for-the-badge&logo=OpenSearch&logoColor=white)

## Ввод новых нод

### Чекпоинты

1. Развернуть 2+ ноды Opensearch и соединить их в один [кластер](https://docs.opensearch.org/docs/latest/install-and-configure/configuring-opensearch/cluster-settings#cluster-level-routing-and-allocation-settings);
2. Создать индекс, который будет использоваться для переноса, и заполнить его данными;
3. Отключить автоматическое ребалансирование индексов в кластере;
4. Добавить новые ноды в кластер;
5. Добавить в исключение старые ноды для ребалансировки;
6. Включить автоматическую ребалансировку;
7. Дождаться завершения процесса переноса индексов;
8. Отключить старые ноды;

### Результат

При использовании запроса GET _cat/shards?v все шарды индекса должны иметь статус STARTED и находиться на новых нодах. При отключении старых нод, индекс должен иметь статус Green.

## Реиндексация в удаленный кластер

### Чекпоинты

1. Развернуть 2 кластера по 2+ ноды Opensearch;
2. Добавить в файл opensearch.yml разрешение на использование удаленного кластера для реиндексации;
3. Создать в кластере, куда переносятся данные, индекс с параметрами и маппингами, как на кластере источнике;
4. Выполнить запрос на запуск [реиндексации](https://docs.opensearch.org/docs/latest/im-plugin/reindex-data/), указав в качестве источника индекс на удаленном кластере;
5. Дождаться окончания переноса данных.

### Результат

В обоих кластерах должны быть индексы с одинаковым количество документов в них.

## Контакты

Не стесняйтесь задавать вопросы в [нашем Telegram чате](https://t.me/+nSELCyIX8ltlNjU6)!
